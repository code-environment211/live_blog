<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Detail - Live Blog</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="logo">LiveBlog</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li class="auth-required"><a href="create-blog.html">Create Blog</a></li>
                    <li class="auth-required"><a href="my-blogs.html">My Blogs</a></li>
                    <li class="guest-only"><a href="login.html">Login</a></li>
                    <li class="guest-only"><a href="register.html">Register</a></li>
                    <li class="auth-required"><a href="#" onclick="AuthManager.logout()">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div id="alert-container"></div>
            
            <!-- Blog Content -->
            <div id="blog-container">
                <div class="text-center">
                    <div class="loading"></div>
                    <p>Loading blog...</p>
                </div>
            </div>

            <!-- Comments Section -->
            <div id="comments-section" class="comments-section hidden">
                <h3>Comments</h3>
                
                <!-- Add Comment Form (for authenticated users) -->
                <div id="comment-form-container" class="auth-required hidden">
                    <form id="comment-form" class="mb-3">
                        <div class="form-group">
                            <textarea id="comment-content" name="content" class="form-control" 
                                    placeholder="Write your comment..." rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Comment</button>
                    </form>
                </div>

                <!-- Comments List -->
                <div id="comments-container">
                    <div class="text-center">
                        <div class="loading"></div>
                        <p>Loading comments...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="static/js/api.js"></script>
    <script src="static/js/auth.js"></script>
    <script>
        let blogId = null;
        let currentBlog = null;

        // Get blog ID from URL parameters
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            blogId = urlParams.get('id');
            
            if (!blogId) {
                showAlert('Blog not found', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            loadBlog();
            loadComments();
            setupCommentForm();
            
            // Show comment form if authenticated
            if (api.isAuthenticated()) {
                document.getElementById('comment-form-container').classList.remove('hidden');
            }
        });

        async function loadBlog() {
            try {
                const container = document.getElementById('blog-container');
                container.innerHTML = '<div class="text-center"><div class="loading"></div><p>Loading blog...</p></div>';

                currentBlog = await api.getBlog(blogId);
                displayBlog(currentBlog);
                
                // Show comments section
                document.getElementById('comments-section').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading blog:', error);
                document.getElementById('blog-container').innerHTML = 
                    '<div class="card text-center"><p>Error loading blog. Please try again.</p></div>';
            }
        }

        function displayBlog(blog) {
            const container = document.getElementById('blog-container');
            
            container.innerHTML = `
                <div class="card">
                    <div class="blog-header">
                        <div>
                            <h1 class="blog-title">${blog.title}</h1>
                            <div class="blog-meta">
                                <span>By ${blog.author}</span>
                                <span>${formatDate(blog.timestamp)}</span>
                                <span class="status-badge status-${blog.event_status.toLowerCase()}">${blog.event_status}</span>
                            </div>
                        </div>
                    </div>
                    <div class="blog-content" style="white-space: pre-wrap; margin-top: 2rem;">
                        ${blog.content}
                    </div>
                    <div class="blog-actions mt-3">
                        <a href="index.html" class="btn btn-secondary">Back to Home</a>
                    </div>
                </div>
            `;
        }

        async function loadComments() {
            try {
                const container = document.getElementById('comments-container');
                container.innerHTML = '<div class="text-center"><div class="loading"></div><p>Loading comments...</p></div>';

                const data = await api.getComments(blogId);
                displayComments(data.results || []);
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('comments-container').innerHTML = 
                    '<div class="text-center"><p>Error loading comments.</p></div>';
            }
        }

        function displayComments(comments) {
            const container = document.getElementById('comments-container');
            
            if (comments.length === 0) {
                container.innerHTML = '<div class="text-center"><p>No comments yet. Be the first to comment!</p></div>';
                return;
            }

            // Filter comments for this blog
            const blogComments = comments.filter(comment => comment.blog == blogId);
            
            if (blogComments.length === 0) {
                container.innerHTML = '<div class="text-center"><p>No comments yet. Be the first to comment!</p></div>';
                return;
            }

            container.innerHTML = blogComments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">${comment.user}</span>
                        <span class="comment-date">${formatDate(comment.created_at)}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                </div>
            `).join('');
        }

        function setupCommentForm() {
            document.getElementById('comment-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!api.isAuthenticated()) {
                    showAlert('Please login to comment', 'error');
                    return;
                }
                
                const submitBtn = this.querySelector('button[type="submit"]');
                setLoading(submitBtn, true);
                
                const formData = new FormData(this);
                const commentData = {
                    blog: parseInt(blogId),
                    content: formData.get('content')
                };
                
                // Validate form
                const errors = validateForm(commentData, {
                    content: { required: true, minLength: 1 }
                });
                
                if (Object.keys(errors).length > 0) {
                    displayFormErrors(errors);
                    setLoading(submitBtn, false);
                    return;
                }
                
                try {
                    await api.createComment(commentData);
                    showAlert('Comment added successfully!', 'success');
                    this.reset();
                    loadComments(); // Reload comments
                } catch (error) {
                    showAlert(error.message || 'Failed to add comment', 'error');
                } finally {
                    setLoading(submitBtn, false);
                }
            });
        }
    </script>
</body>
</html>